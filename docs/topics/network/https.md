# HTTPS

## 一、HTTPS 是什么

HTTPS（全称：Hyper Text Transfer Protocol over SecureSocket Layer，超文本安全传输协议）并不是一种新的协议，而是在HTTP的基础上加入了SSL（全称：SecureSocket Layer，安全套接层）层来保证传输过程的安全。原本，HTTP与下层的TCP直接通信，但在HTTPS中，HTTP得先和SSL通信，然后SSL再和TCP通信。因此，HTTPS说白了也就是HTTP套的SSL壳。

在采用了SSL之后，HTTP就拥有的了加密、证书和完整性保护的功能。

![](http://sinacloud.net/wycblog/githubimg/HTTP%E4%B8%8EHTTPS.png?KID=sina,35csxclN8sEkGjPfjiEN&Expires=1576413075&ssig=i8cbxRLCdH)

## 二、HTTPS 出现的背景

HTTP 是非常优秀的数据传输协议，但是也有它的不足，这些不足主要体现在安全方面，如下：

* 通信使用明文，内容可能会被监听
* 不验证通信方身份，有可能遭遇到伪装
* 无法验证报文的完整性，所以有可能已遭篡改

安全的问题不仅仅有上面的原因，同时也因为 TCP/IP 的设计本身也是不安全的。 TCP/IP 协议族用于互联网的建设，所以数据是可以到达网络的每一个节点的，因此数据在的传输中是能被所有接入网络的用户接收到。很难保证在全球这么巨大的网络中，不会有恶意的用户在网络中通过抓包的方式去获取其他人的数据。

![](http://sinacloud.net/wycblog/githubimg/https.png?KID=sina,35csxclN8sEkGjPfjiEN&Expires=1576423950&ssig=5qHqGcb5gh)

## 三、HTTPS 如何保证通信安全的

正如刚刚说到的，既然处于互联网中，数据就存在被人窃听的风险。那让数据变得安全的方式**并不是让别人窃听不到数据，而是将数据加密，使得加密后的数据难以被破解**。HTTPS保证通信安全的原理也是这样，但是其中有些过程会比较复杂，会涉及到对称加密、非对称加密和数字证书的知识。

> 注：不存在绝对安全的加密方式，所有的安全都是提高攻击者的攻击成本

### 3.1 加密和证书的作用

#### 对称加密

在HTTPS通信的过程中会对报文主体进行加密，接收到报文后，接收方需要对报文主体进行解密从而得到数据。有些同学可能不太理解加密的作用，通俗的来说，可以理解如下：

> 广东人A（客户端）：我丢雷楼某，扑街仔  
> 广东人B（服务端）：食屎啦（学友表情）  
> 外地人（其他用户）：？？？

上面的外地人可能就会存在恶意用户，完全不知道楼上在说啥，还可能以为他们是在打招呼吧。在上述通信中，广东的方言——粤语就是加密和解密的规则，并且通信双方只要能辨认加密规则并解密，就可以进行沟通了。

在加密的过程中，会涉及到密钥和加密算法。在广东话这个例子中，将粤语和语义互相转化的就是加密算法。他们的口音可以理解成密钥，密钥的存在会加大别人解析语义的难度。这种加密和解密使用同一密钥的加密方式就被称为**对称加密**。

#### 非对称加密

对称加密虽然具有一定的安全性，但是还不够，恶意攻击者可以使用暴力破解、截获密钥这些方式来破解。因此需要非对称加密的方式来提高安全性。为什么非对称加密具有这么高的安全性呢？

非对称加密算法需要两个密钥分别来进行加密和解密，这两个密钥被称为公开密钥和私有密钥。公开密钥和私有密钥都能进行加密，但是解密的时候只能用另一个来解密。公开密钥和私有密钥是一对的，公钥加密的，只有私钥才能解密，那么非对称加密的安全性就大大的提高了。将公钥发放出去，然后保管好私钥即可。

非对称加密算法的原理所涉及的数学知识就非常多了，像著名的大费马定理、关于偶数的哥德巴赫猜想。同样的，这些数学知识也是佐证这个加密算法的安全性会有多高（**注：不是绝对安全，RSA256加密算法已有被暴力破解的例子**）。

#### 数字证书

上面介绍了两种加密方式，既然都有这么安全的加密方式，那么数字证书是什么，又有什么作用呢？

**数字证书是由权威的CA机构或是由CA机构授权的其他机构给服务端进行颁发，CA机构通过服务端提供的相关信息生成证书，证书内容包含了持有人的相关信息，公钥，签署者签名信息等，最重要的是公钥在数字证书中。**

那数字证书的作用就很显而易见了，在 HTTPS 中非对称加密使用的密钥是由CA机构提供，同时CA机构还会证明服务端的身份。在这里，CA机构的权威是非常重要的，所有用户都会相信CA机构给出的证明。

> 尽管CA机构被黑客成功的攻击过，你还是得相信他

### 3.2 伪装攻击和中间人攻击

HTTP协议的请求和响应不会对通信方进行验证，也就是发生任何人都可以请求、任何请求服务端都会响应。如果客户端或服务端是伪装的，或是有人拦截了请求又发送伪造的请求，那通信的安全就难以保证了。这里我们介绍比较常见的两种攻击方式：伪装攻击和中间人攻击。

* 伪装攻击：攻击者会伪装成服务端，用相似的域名、网站、ip欺骗或其他手段来伪装自己，让用户很难区别这是否是用户真正要访问的网站。当用户在这个网站输入敏感数据的时候，攻击者就收到了用户的数据，达到了攻击的目的。常见的钓鱼网站就是这样攻击用户的。（除了服务器可以伪装，客户端同样可以伪装，这里以服务器伪装为例进行讲解）

* 中间人攻击：在客户端与服务端通信的过程中，某个网络节点有恶意用户抓包了数据，并且可能篡改了数据，将篡改后的数据发给服务端。当服务端响应篡改的数据后，再将响应的数据处理并返回给客户端。在这次通信的过程中，中间人会参与客户端和服务端的通信，可能会修改他们通信的数据，这样的攻击方式就是中间人攻击。

那么，HTTPS是如何防范这两种攻击的呢？

1. 防范伪装攻击：此攻击的着重点在于，用户很难区分他请求的服务器就是他想要请求的服务器。在HTTPS中，由权威的CA机构颁发的证书将服务器的公钥、证书和公司信息绑定在一起，就可以确定通信方，并且证书的伪造从技术上来说难度极大。

2. 防范中间人攻击：在通信的过程中，可能会有恶意的第三方抓包并篡改数据。HTTP提供了验证了数据完整性的方法，但是不可靠、便捷。而，HTTPS会对通信的数据进行加密，第三方获取了数据也很难解析数据的含义。并且还提供了摘要算法来验证数据是否被修改过。

3. 防范劫持HTTPS的中间人攻击：这个中间人不仅仅会抓包数据，还会伪造密钥怎么办？毕竟之前说过，伪造的难度高确实高，但不是不可能。假如攻击者去生成一对密钥和配套的证书，只要保证三者是一套就行了。好在浏览器默认只会相信CA机构或CA机构授权的机构提供的证书，伪造的证书无法通过认证。

## 四、HTTPS 的通信

### 4.1 通信步骤

HTTPS的通信过程分为4个阶段，主要的步骤有12个。

----

**SSL第一次握手**

步骤1：客户端通过发送 Client Hello 报文开始SSL通信。报文中包含客户端支持的SSL的指定版本、加密组件列表。

步骤2：服务器可进行SSL通信时，会以Server Hello 报文作为应答。和客户端一样，在报文中包含SSL版本以及加密组件。

步骤3：之后服务器发送 Certificate 报文，报文中包含公开密钥和证书。

步骤4：最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的SSL握手协商部分结束。

----

**SSL第二次握手**

步骤5：SSL第一次握手结束之后，客户端以 Client Key Exchange 报文作为回应。报文中包含被称为 Pre-master secret 的随机密码串。报文已使用步骤3中的公开密钥加密。

步骤6：接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre-master secret 密钥加密。

步骤7：客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。

步骤8：服务器同样发送 Change Cipher Spec 报文。

步骤9：服务器同样发送 Finished 报文。

----

**SSL第三次握手和交换数据**

步骤10：服务器和客户端的 Finished 报文交换完毕之后， SSL 连接就算建立完成。从此开始发送HTTP请求。

步骤11：应用层协议通信，开始发送HTTP响应。

----

**断开连接**

步骤12：最后由客户端断开连接。发送 close_notify 报文。这步之后，发送TCP FIN码关闭和TCP的通信。

上述过程用图表示如下：

![](http://sinacloud.net/wycblog/githubimg/https%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B.png?KID=sina,35csxclN8sEkGjPfjiEN&Expires=1576426168&ssig=rnl0cuQhfn)

### 4.2 建立连接过程图解

HTTPS建立连接的过程如下图。在这个过程中，使用非对称加密保护随机密码串的发生；对称加密使用的初始加密向量并不是随机密码串，而是通过随机密码串生成的。

![](http://sinacloud.net/wycblog/githubimg/https%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B.png?KID=sina,35csxclN8sEkGjPfjiEN&Expires=1576919359&ssig=QvdVjqlj%2Bf)

